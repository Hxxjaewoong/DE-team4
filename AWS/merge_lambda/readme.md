# ğŸ“ Merge Lambda (`merge_lambda`)

## ğŸ“Œ ê°œìš”
`merge_lambda`ëŠ” **Step Function ë‚´ì—ì„œ ì‹¤í–‰ë˜ë©°, ì—¬ëŸ¬ ì»¤ë®¤ë‹ˆí‹° ì‚¬ì´íŠ¸(DCInside, BobaeDream, Clien, FMKorea)ì˜ ë³¸ë¬¸ ë° ëŒ“ê¸€ ë°ì´í„°ë¥¼ ë³‘í•©í•˜ì—¬ S3ì— ì €ì¥**í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.  
ê° `parse` Lambdaê°€ ìƒì„±í•œ Parquet íŒŒì¼ì„ ë¶ˆëŸ¬ì™€ í•©ì¹œ í›„, **Parquet í¬ë§·ìœ¼ë¡œ S3ì— ì—…ë¡œë“œ**í•©ë‹ˆë‹¤.

---

## ğŸ“‚ ì…ë ¥ ë°ì´í„°
LambdaëŠ” S3ì—ì„œ **ê° ì»¤ë®¤ë‹ˆí‹°ë³„ ë³¸ë¬¸ ë° ëŒ“ê¸€ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ë³‘í•©**í•©ë‹ˆë‹¤.  
íŒŒì¼ì€ ì•„ë˜ ê²½ë¡œì—ì„œ ê°€ì ¸ì˜µë‹ˆë‹¤:

ğŸ“¥ **ì…ë ¥ ë°ì´í„° ê²½ë¡œ**
- ë³¸ë¬¸ ë°ì´í„°: `raw_data/{site}/yyyy-mm-dd-content.csv`
- ëŒ“ê¸€ ë°ì´í„°: `raw_data/{site}/yyyy-mm-dd-comment.csv`
  
âœ… `site`ëŠ” ë‹¤ìŒ ì¤‘ í•˜ë‚˜:
  - `dcinside`
  - `bobae`
  - `clien`
  - `fmkorea`

---

## ğŸ“¤ ì¶œë ¥ ë°ì´í„°
ë³‘í•©ëœ ë°ì´í„°ëŠ” ì•„ë˜ ê²½ë¡œì— **Parquet íŒŒì¼** í˜•ì‹ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.

ğŸ“€ **ì¶œë ¥ ë°ì´í„° ê²½ë¡œ**
- ë³¸ë¬¸ ë°ì´í„°: `merge_data/contents/yyyy-mm-dd.parquet`
- ëŒ“ê¸€ ë°ì´í„°: `merge_data/comments/yyyy-mm-dd.parquet`

---

## ğŸ“Š ì €ì¥ ë°ì´í„° í˜•ì‹
### ğŸ“Œ ë³¸ë¬¸ ë°ì´í„° (`merge_data/contents/yyyy-mm-dd.parquet`)
| ì»¬ëŸ¼ëª…          | íƒ€ì…      | ì„¤ëª… |
|---------------|---------|----------------------------------|
| site         | string  | ì‚¬ì´íŠ¸ëª… (ì˜ˆ: `"dcinside"`) |
| datetime     | datetime | ê²Œì‹œê¸€ ì‘ì„± ì‹œê°„ |
| model       | string  | ê²€ìƒ‰ í‚¤ì›Œë“œ |
| title       | string  | ê²Œì‹œê¸€ ì œëª© |
| content     | string  | ê²Œì‹œê¸€ ë‚´ìš© |
| url         | string  | ê²Œì‹œê¸€ URL |
| author      | string  | ì‘ì„±ì (ì‚¬ìš© ì•ˆí•¨) |
| likes       | int     | ì¶”ì²œ ìˆ˜ |
| hates       | int     | ë¹„ì¶”ì²œ ìˆ˜ |
| comments_count | int     | ëŒ“ê¸€ ê°œìˆ˜ |
| views       | int     | ì¡°íšŒìˆ˜ |

### ğŸ“Œ ëŒ“ê¸€ ë°ì´í„° (`merge_data/comments/yyyy-mm-dd.parquet`)
| ì»¬ëŸ¼ëª…  | íƒ€ì…   | ì„¤ëª… |
|--------|--------|------|
| url    | string | ê²Œì‹œê¸€ URL |
| title  | string | ê²Œì‹œê¸€ ì œëª© |
| comment | string | ëŒ“ê¸€ ë‚´ìš© |

---

## ğŸ”„ ì‹¤í–‰ íë¦„
1. **Step Functionì—ì„œ `merge_lambda` ì‹¤í–‰**
2. **S3ì—ì„œ `raw_data/{site}/yyyy-mm-dd-content.csv` ë° `raw_data/{site}/yyyy-mm-dd-comment.csv` ê°€ì ¸ì˜¤ê¸°**
3. **Pandasë¥¼ ì‚¬ìš©í•´ ë°ì´í„° ë³‘í•©**
4. **ë³‘í•©ëœ ë°ì´í„°ë¥¼ `merge_data/contents/yyyy-mm-dd.parquet`, `merge_data/comments/yyyy-mm-dd.parquet`ì— ì €ì¥**
5. **Slackìœ¼ë¡œ ì„±ê³µ/ì‹¤íŒ¨ ë¡œê·¸ ì „ì†¡**
6. **Step Functionì— ë³‘í•© ê²°ê³¼ ë°˜í™˜**

---

## ğŸ›‘ ì˜¤ë¥˜ ì²˜ë¦¬
Lambda ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ ì‹œ, **`crawling_log_lambda`** ë¥¼ í˜¸ì¶œí•˜ì—¬ Slackìœ¼ë¡œ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.

### 1ï¸âƒ£ **S3ì—ì„œ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ëŠ” ê²½ìš°**
- `list_s3_files()` ë‹¨ê³„ì—ì„œ **S3ì— í•´ë‹¹ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°**, ë¡œê·¸ë¥¼ ë‚¨ê¸°ê³  ë¹ˆ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜.

ì˜ˆì œ ì˜¤ë¥˜ ë©”ì‹œì§€:
```md
ğŸš¨ **ì˜¤ë¥˜ ë°œìƒ!**
- **ìœ„ì¹˜:** `merge_lambda`
- **ë‹¨ê³„:** `upload_parquet_to_s3`
- **ì˜¤ë¥˜ ë©”ì‹œì§€:**  
```


### 2ï¸âƒ£ **ë³‘í•©í•  ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš°**
- ë³¸ë¬¸ ë° ëŒ“ê¸€ ë°ì´í„°ë¥¼ ë³‘í•©í•œ ê²°ê³¼ê°€ **ë¹„ì–´ ìˆëŠ” ê²½ìš°**, Step Functionì˜ ì •ìƒ ì§„í–‰ì„ ë°©í•´í•˜ì§€ ì•Šë„ë¡ `log_error()`ë¥¼ ì‹¤í–‰.
- ë‹¨, **ë³‘í•©ëœ ë³¸ë¬¸ ë° ëŒ“ê¸€ ë°ì´í„°ê°€ ëª¨ë‘ ì—†ëŠ” ê²½ìš°** `NoDataToMergeException`ì„ ë°œìƒì‹œí‚¤ê³  Step Functionì—ì„œ ì˜¤ë¥˜ë¡œ ì²˜ë¦¬ë¨.

ì˜ˆì œ ì˜¤ë¥˜ ë©”ì‹œì§€:
```md
ğŸš¨ **ë³‘í•© ì˜¤ë¥˜ ë°œìƒ!**
- **ìœ„ì¹˜:** `merge_lambda`
- **ë‹¨ê³„:** `lambda_handler`
- **ì˜¤ë¥˜ ë©”ì‹œì§€:**  
```
